<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, user-scalable=no" name="viewport" />
    <title>Retro Word Tetris</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #000;
        color: #fff;
        font-family: 'Press Start 2P', cursive;
      }
      
      .active {
        display: block !important;
      }
      
      .screen {
        display: none;
        width: 640px;
        height: 960px;
        position: absolute;
        top: calc(50% - 480px);
        left: calc(50% - 320px);
        border: 1px solid black;
        background-color: #000;
        color: #fff;
      }
      
      #start-menu-screen .container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
      }
      
      #start-menu-screen .container #game-title {
        font-size: 24px;
        margin-bottom: 40px;
      }
      
      #start-menu-screen .container button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #fff;
        color: #000;
        border: none;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
      }
      
      #settings-screen.screen .container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
      }
      
      #settings-screen.screen .container button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #fff;
        color: #000;
        border: none;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
      }
      
      #instructions-screen.screen .container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        height: 100%;
        overflow-y: auto;
      }
      
      #instructions-screen.screen .container button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #fff;
        color: #000;
        border: none;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
      }
      
      #game-container.screen .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        height: 100%;
        box-sizing: border-box;
      }
      
      #game-container.screen .container button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #fff;
        color: #000;
        border: none;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
      }
      
      #game-over-screen.screen .container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
      }
      
      #game-over-screen.screen .container #game-over-message {
        font-size: 24px;
        margin-bottom: 40px;
      }
      
      #game-over-screen.screen .container button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #fff;
        color: #000;
        border: none;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
      }
      
      /* Game-Specific Styles */
      #hud {
        display: flex;
        justify-content: space-between;
        width: 400px;
        margin-bottom: 20px;
      }

      #score, #highScore {
        font-size: 16px;
      }

      #nextLetterContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-left: 20px;
      }

      #nextLetterLabel {
        font-size: 16px;
        margin-bottom: 10px;
      }

      #nextLetter {
        width: 40px;
        height: 40px;
        background-color: #fff;
        color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
      }

      #gameBoard {
        display: grid;
        grid-template-columns: repeat(10, 40px);
        grid-template-rows: repeat(20, 40px);
        gap: 1px;
        background-color: #333;
      }

      .cell {
        width: 40px;
        height: 40px;
        background-color: #000;
        border: 1px solid #555;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        color: #fff;
      }

      #wordListUpload {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Start Menu Screen -->
    <div class="active screen" id="start-menu-screen">
      <div class="container">
        <h1 id="game-title">Retro Word Tetris</h1>
        <button id="play-button">Play</button>
        <button id="settings-button">Settings</button>
        <button id="instructions-button">Instructions</button>
      </div>
    </div>

    <!-- Settings Screen -->
    <div class="screen" id="settings-screen">
      <div class="container">
        <h2>Settings</h2>
        <!-- Add your settings options here -->
        <button class="main-menu-button" id="setting-back-button">Back</button>
      </div>
    </div>

    <!-- Instructions Screen -->
    <div class="screen" id="instructions-screen">
      <div class="container">
        <h2>Instructions</h2>
        <p>Welcome to Retro Word Tetris! The goal of the game is to form words using falling letters. Here are the controls:</p>
        <ul>
          <li><strong>Arrow Left:</strong> Move the letter left</li>
          <li><strong>Arrow Right:</strong> Move the letter right</li>
          <li><strong>Arrow Down:</strong> Move the letter down faster</li>
          <li><strong>Spacebar:</strong> Drop the letter quickly</li>
          <li><strong>P:</strong> Pause the game</li>
        </ul>
        <p>Form valid words to score points. The game ends when the letters reach the top of the game board.</p>
        <button class="main-menu-button" id="instructions-back-button">Back</button>
      </div>
    </div>

    <!-- Game Screen -->
    <div class="screen" id="game-container">
      <div class="container">
        <div id="hud">
          <div id="score">Score: 0</div>
          <div id="highScore">High Score: 0</div>
          <div id="nextLetterContainer">
            <div id="nextLetterLabel">Next:</div>
            <div id="nextLetter">A</div>
          </div>
        </div>
        <div id="gameBoard">
          <!-- Cells will be dynamically generated here -->
        </div>
        <button id="instructionsButton">Instructions</button>
        <!-- File input for word list upload (optional) -->
        <input type="file" id="wordListUpload" accept=".txt">
      </div>
    </div>

    <!-- Game Over Screen -->
    <div class="screen" id="game-over-screen">
      <div class="container">
        <div id="game-over-message">Game Over!</div>
        <button id="play-again-button">Play Again</button>
        <button class="main-menu-button" id="game-over-main-menu-button">Main Menu</button>
      </div>
    </div>

    <!-- Audio Elements (Optional) -->
    <!-- <audio autoplay="" id="background-music" loop>
      <source src="background-music.mp3" type="audio/mpeg" />
    </audio>
    <audio id="start-game-sound">
      <source src="start-game-sound.mp3" type="audio/mpeg" />
    </audio> -->
    <!-- Extra audio tags for sound effects can be added here if needed -->

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        class GameUI {
          constructor() {
            this.startMenuScreen = document.getElementById('start-menu-screen');
            this.settingsScreen = document.getElementById('settings-screen');
            this.instructionsScreen = document.getElementById('instructions-screen');
            this.gameContainer = document.getElementById('game-container');
            this.gameOverScreen = document.getElementById('game-over-screen');

            // Game Elements
            this.scoreElement = document.getElementById('score');
            this.highScoreElement = document.getElementById('highScore');
            this.nextLetterElement = document.getElementById('nextLetter');
            this.gameBoard = document.getElementById('gameBoard');
            this.instructionsButton = document.getElementById('instructionsButton');
            this.wordListUpload = document.getElementById('wordListUpload');
            this.gameOverMessage = document.getElementById('game-over-message');
          }

          swapToScreen(screen) {
            this.startMenuScreen.classList.remove('active');
            this.settingsScreen.classList.remove('active');
            this.instructionsScreen.classList.remove('active');
            this.gameContainer.classList.remove('active');
            this.gameOverScreen.classList.remove('active');
            screen.classList.add('active');
          }

          startGame() {
            // Optional: Play start game sound
            // const startGameSound = document.getElementById('start-game-sound');
            // startGameSound.play();

            this.swapToScreen(this.gameContainer);
          }

          endGame(score, highScore) {
            this.gameOverMessage.innerText = `Game Over!\nYour Score: ${score}\nHigh Score: ${highScore}`;
            this.swapToScreen(this.gameOverScreen);
            // Optional: Play end game sound
            // const endGameSound = document.getElementById('end-game-sound');
            // endGameSound.play();
          }

          updateHUD(score, highScore, nextLetter) {
            this.scoreElement.innerText = `Score: ${score}`;
            this.highScoreElement.innerText = `High Score: ${highScore}`;
            this.nextLetterElement.innerText = nextLetter;
          }

          initializeGameBoard(rows, cols, addCellCallback) {
            this.gameBoard.innerHTML = '';
            this.gameBoard.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
            this.gameBoard.style.gridTemplateRows = `repeat(${rows}, 40px)`;
            for (let row = 0; row < rows; row++) {
              for (let col = 0; col < cols; col++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.row = row;
                cell.dataset.col = col;
                addCellCallback(cell);
                this.gameBoard.appendChild(cell);
              }
            }
          }
        }

        class GameLogic {
          constructor(ui) {
            this.ui = ui;
            this.score = 0;
            this.highScore = 0;
            this.nextLetter = 'A';
            this.gameInterval = null;
            this.gameSpeed = 1000;
            this.currentLetter = null;
            this.currentPosition = { row: 0, col: 4 };
            this.isPaused = false;
            this.dictionary = [];
            this.letterPoints = { 'A': 1, 'B': 3, 'C': 3, 'D': 2, 'E': 1, 'F': 4, 'G': 2, 'H': 4, 'I': 1, 'J': 8, 'K': 5, 'L': 1, 'M': 3, 'N': 1, 'O': 1, 'P': 3, 'Q': 10, 'R': 1, 'S': 1, 'T': 1, 'U': 1, 'V': 4, 'W': 4, 'X': 8, 'Y': 4, 'Z': 10 };
          }

          async loadWordList(url) {
            try {
              const response = await fetch(url);
              const text = await response.text();
              this.dictionary = text.split('\n').map(word => word.trim().toUpperCase());
              console.log('Word list loaded:', this.dictionary.slice(0, 10)); // Log first 10 words to check
            } catch (error) {
              console.error('Failed to load word list:', error);
            }
          }

          getRandomLetter() {
            const weightedLetters = [];
            const vowels = ['A', 'E', 'I', 'O', 'U'];
        
            // Generate the weighted pool of letters based on their point values and increase vowel frequency
            for (let letter in this.letterPoints) {
              let frequency = 11 - this.letterPoints[letter]; // Higher frequency for low point letters
              
              // Increase the frequency for vowels
              if (vowels.includes(letter)) {
                frequency *= 2; // Double the frequency for vowels
              }
              
              // Add the letter to the pool 'frequency' times
              for (let i = 0; i < frequency; i++) {
                weightedLetters.push(letter);
              }
            }
        
            // Pick a random letter from the weighted pool
            return weightedLetters[Math.floor(Math.random() * weightedLetters.length)];
          }

          createGameBoard(rows, cols) {
            this.ui.initializeGameBoard(rows, cols, (cell) => {
              // Additional cell initialization if needed
            });
          }

          updateHUD() {
            this.ui.updateHUD(this.score, this.highScore, this.nextLetter);
          }

          placeLetter(row, col, letter) {
            const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
            if (cell) {
              cell.innerText = letter;
            }
          }

          clearLetter(row, col) {
            const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
            if (cell) {
              cell.innerText = '';
            }
          }

          isOccupied(row, col) {
            const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
            return cell && cell.innerText !== '';
          }

          calculateWordScore(word) {
            return word.split('').reduce((acc, letter) => acc + this.letterPoints[letter], 0);
          }

          clearWord(row, startCol, length) {
            for (let col = startCol; col < startCol + length; col++) {
              const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
              if (cell) {
                cell.innerText = ''; // Clear the letter from the board
              }
            }
          }

          checkForWords() {
            for (let row = 0; row < 20; row++) {
              let word = '';
              let startCol = 0;
              for (let col = 0; col < 10; col++) {
                const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
                if (cell && cell.innerText !== '') {
                  word += cell.innerText;
                } else {
                  // Only score the word if it's 3 letters or more and is in the dictionary
                  if (word.length >= 3 && this.dictionary.includes(word)) {
                    this.score += this.calculateWordScore(word);
                    this.clearWord(row, col - word.length, word.length);
                  }
                  word = ''; // Reset the word
                }
              }
              // Check the last word in the row if it ends without an empty space
              if (word.length >= 3 && this.dictionary.includes(word)) {
                this.score += this.calculateWordScore(word);
                this.clearWord(row, 10 - word.length, word.length);
              }
            }
            this.updateHUD(); // Update the score and high score display
          }

          moveLetterDown() {
            if (this.currentPosition.row < 19 && !this.isOccupied(this.currentPosition.row + 1, this.currentPosition.col)) {
              this.clearLetter(this.currentPosition.row, this.currentPosition.col);
              this.currentPosition.row++;
              this.placeLetter(this.currentPosition.row, this.currentPosition.col, this.currentLetter);
            } else {
              this.checkForWords();
              if (this.currentPosition.row === 0) {
                this.endGame();
                return;
              }
              this.currentLetter = this.nextLetter;
              this.nextLetter = this.getRandomLetter();
              this.currentPosition = { row: 0, col: 4 };
              this.updateHUD();
              this.placeLetter(this.currentPosition.row, this.currentPosition.col, this.currentLetter);
            }
          }

          moveLetterLeft() {
            if (this.currentPosition.col > 0 && !this.isOccupied(this.currentPosition.row, this.currentPosition.col - 1)) {
              this.clearLetter(this.currentPosition.row, this.currentPosition.col);
              this.currentPosition.col--;
              this.placeLetter(this.currentPosition.row, this.currentPosition.col, this.currentLetter);
            }
          }

          moveLetterRight() {
            if (this.currentPosition.col < 9 && !this.isOccupied(this.currentPosition.row, this.currentPosition.col + 1)) {
              this.clearLetter(this.currentPosition.row, this.currentPosition.col);
              this.currentPosition.col++;
              this.placeLetter(this.currentPosition.row, this.currentPosition.col, this.currentLetter);
            }
          }

          quickDropLetter() {
            while (this.currentPosition.row < 19 && !this.isOccupied(this.currentPosition.row + 1, this.currentPosition.col)) {
              this.moveLetterDown();
            }
          }

          rotateLetter() {
            // Rotation logic can be implemented if letters have different orientations
            // For single letters, rotation may not be necessary
          }

          pauseGame() {
            if (this.isPaused) {
              this.gameInterval = setInterval(() => this.moveLetterDown(), this.gameSpeed);
              this.isPaused = false;
            } else {
              clearInterval(this.gameInterval);
              this.isPaused = true;
            }
          }

          startGameLoop() {
            this.gameInterval = setInterval(() => this.moveLetterDown(), this.gameSpeed);
          }

          endGame() {
            clearInterval(this.gameInterval);
            if (this.score > this.highScore) {
              this.highScore = this.score;
            }
            this.ui.endGame(this.score, this.highScore);
          }

          resetGame() {
            // Reset game variables
            this.score = 0;
            this.currentLetter = this.getRandomLetter();
            this.nextLetter = this.getRandomLetter();
            this.currentPosition = { row: 0, col: 4 };
            this.isPaused = false;
            this.updateHUD();
            this.createGameBoard(20, 10);
            this.placeLetter(this.currentPosition.row, this.currentPosition.col, this.currentLetter);
            this.startGameLoop();
          }

          initialize() {
            this.createGameBoard(20, 10);
            this.resetGame();
          }
        }

        class Game {
          constructor() {
            this.ui = new GameUI();
            this.logic = new GameLogic(this.ui);
            this.assignButtons();
          }

          prepareGame() {
            // Initialize game board and other elements if needed
            // Load the word list
            this.logic.loadWordList('https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt');
          }

          startGame() {
            this.ui.startGame();
            this.logic.initialize();
          }

          playAgain() {
            this.logic.resetGame();
            this.ui.swapToScreen(this.ui.gameContainer);
          }

          endGame() {
            this.logic.endGame();
          }

          mainMenu() {
            this.ui.mainMenu();
          }

          assignButtons() {
            const playButton = document.getElementById('play-button');
            const settingsButton = document.getElementById('settings-button');
            const instructionsButton = document.getElementById('instructions-button');
            const playAgainButton = document.getElementById('play-again-button');
            const gameOverMainMenuButton = document.getElementById('game-over-main-menu-button');
            const settingBackButton = document.getElementById('setting-back-button');
            const instructionsBackButton = document.getElementById('instructions-back-button');
            const inGameInstructionsButton = document.getElementById('instructionsButton');
            const wordListUpload = document.getElementById('wordListUpload');

            playButton.addEventListener('click', this.startGame.bind(this));
            settingsButton.addEventListener('click', () => this.ui.swapToScreen(this.ui.settingsScreen));
            instructionsButton.addEventListener('click', () => this.ui.swapToScreen(this.ui.instructionsScreen));
            playAgainButton.addEventListener('click', this.playAgain.bind(this));
            gameOverMainMenuButton.addEventListener('click', this.mainMenu.bind(this));
            settingBackButton.addEventListener('click', () => this.ui.swapToScreen(this.ui.startMenuScreen));
            instructionsBackButton.addEventListener('click', () => this.ui.swapToScreen(this.ui.startMenuScreen));
            inGameInstructionsButton.addEventListener('click', () => this.ui.swapToScreen(this.ui.instructionsScreen));

            // Optional: Handle word list upload
            wordListUpload.addEventListener('change', (event) => {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  const text = e.target.result;
                  this.logic.dictionary = text.split('\n').map(word => word.trim().toUpperCase());
                  console.log('Custom word list loaded:', this.logic.dictionary.slice(0, 10));
                };
                reader.readAsText(file);
              }
            });

            // Keyboard Controls
            document.addEventListener('keydown', (event) => {
              if (!this.ui.gameContainer.classList.contains('active')) return; // Only listen when game is active
              if (this.logic.isPaused && event.key.toLowerCase() !== 'p') return;
              switch (event.key) {
                case 'ArrowLeft':
                  this.logic.moveLetterLeft();
                  break;
                case 'ArrowRight':
                  this.logic.moveLetterRight();
                  break;
                case 'ArrowDown':
                  this.logic.moveLetterDown();
                  break;
                case ' ':
                  this.logic.quickDropLetter();
                  break;
                case 'p':
                  this.logic.pauseGame();
                  break;
                default:
                  break;
              }
            });
          }
        }

        const game = new Game();
        game.prepareGame();
      });
    </script>
  </body>
</html>
